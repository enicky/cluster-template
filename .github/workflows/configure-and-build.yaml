name: Configure and Build

on:
  workflow_dispatch:

jobs:
  configure:
    runs-on: arc-runner-set
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Azure CLI + mise
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      - name: Download config.yaml from Azure Blob Storage
        run: |
          az storage blob download \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name ${{ secrets.AZURE_STORAGE_CONTAINER }} \
            --name config.yaml \
            --file config.yaml \
            --account-key ${{ secrets.AZURE_STORAGE_KEY }}

      - name: Install Task (go-task)
        run: |
          curl https://mise.run | sh
          ARCH=arm64 /home/runner/.local/bin/mise trust
          ARCH=arm64 /home/runner/.local/bin/mise install

          ARCH=arm64 /home/runner/.local/bin/mise run install
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d
          pip install makejinja

      - name: Run task configure
        run: ./bin/task configure -y

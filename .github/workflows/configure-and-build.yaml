name: Configure and Build

on:
  workflow_dispatch:

jobs:
  configure:
    runs-on: arc-runner-set
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Some Debugging stuff
        run: |
          echo "Debugging information"
          uname -a
          arch
      - name: Install Azure CLI + mise
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      - name: Download config.yaml from Azure Blob Storage
        run: |
          az storage blob download \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --container-name ${{ secrets.AZURE_STORAGE_CONTAINER }} \
            --name config.yaml \
            --file config.yaml \
            --account-key ${{ secrets.AZURE_STORAGE_KEY }}

      - name: Install Task (go-task)
        run: |
          curl https://mise.run | sh
          export PATH="$HOME/.local/bin:$PATH"
          echo "Show mise env variables"
          mise env
          echo "----------------"
          curl -L https://github.com/asdf-vm/asdf/releases/download/v0.18.0/asdf-v0.18.0-linux-arm64.tar.gz -o /tmp/asdf.tar.gz

          ls -la /tmp/

          tar -xvzf /tmp/asdf.tar.gz -C $HOME/.local/bin
          ls -la $HOME/.local/bin/
          export PATH="$HOME/.local/bin:$PATH"

          which mise

          #asdf plugin add ksops https://github.com/janpieper/asdf-ksops.git


          ARCH=arm64 /home/runner/.local/bin/mise trust
          ARCH=arm64 /home/runner/.local/bin/mise install

          ARCH=arm64 /home/runner/.local/bin/mise run install
          echo "mise run install finished"
          echo "Start to install task"
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d
          echo "Task installation finished"
          echo "start pip install makejinja"
          uv pip install makejinja

      - name: Run task configure
        run: ./bin/task configure -y
